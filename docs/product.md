# ClipDock - iOS 外接存储视频迁移 App 产品文档（PRD）

## 1. 产品概述

### 1.1 背景
iPhone 用户经常因视频占用空间过大导致存储告急。用户希望在连接外接存储（U 盘/SSD）后，将 iPhone 本地视频迁移到外接存储并释放手机空间。

### 1.2 产品定位
一个面向个人用户的 iOS 工具型 App，帮助用户安全、可控地将相册中的视频迁移到外接存储。

### 1.3 目标
1. 降低用户手工导出视频的复杂度和时间成本。
2. 在确保数据安全的前提下释放 iPhone 存储空间。
3. 提供清晰的迁移结果与失败可恢复能力。

### 1.4 非目标（MVP 不做）
1. 不做全自动后台迁移（受 iOS 权限与后台限制）。
2. 不做 iCloud 云端视频管理。
3. 不做跨设备同步与多人协作。
4. 不做视频转码、压缩、剪辑。

## 2. 目标用户与场景

### 2.1 目标用户
1. 使用 iPhone 拍摄大量视频的个人用户。
2. 经常遇到“iPhone 存储空间不足”的用户。

### 2.2 核心场景
1. 用户连接外接存储后，打开 App。
2. App 扫描可迁移视频并按日期排序展示。
3. 用户手动勾选需要迁移的视频。
4. App 将选中视频复制到外接存储并校验完整性。
5. 用户确认后删除相册原视频，释放空间。

## 3. 用户流程（MVP）

1. 首次授权：
   - 授权照片访问（建议 `PHAccessLevel.readWrite`）。
   - 通过系统文件选择器选择外接存储目标目录。
2. 扫描视频并按日期排序：
   - 从照片库读取视频资产，默认按拍摄时间降序。
3. 用户手动选择要迁移的视频（新增步骤）：
   - 支持单选/多选/全选。
   - 页面显示选中总数量、总大小。
4. 执行迁移：
   - 将视频导出并写入目标目录。
   - 记录迁移状态（成功/失败/重试）。
5. 完整性校验：
   - 基于文件大小、时长、可读性进行基本校验。
6. 删除原视频：
   - 仅对“迁移+校验成功”项目触发删除。
   - 用户二次确认后删除相册原视频。
7. 结果展示：
   - 展示迁移成功数、失败数、释放空间估算。

## 4. MVP 功能定义与验收标准

### 4.1 F1 - 外接存储目录选择与记忆
1. 用户可通过系统文件选择器选定目标目录。
2. App 使用安全书签保存目录访问权限。
3. 下次打开可直接使用上次目录（若失效则提示重新选择）。

验收标准：
1. 断开并重连外接存储后，目录可恢复访问或提示修复。
2. 目录不可写时给出明确错误信息。

### 4.2 F2 - 视频扫描与日期排序
1. 扫描照片库视频资产（仅视频）。
2. 默认按拍摄日期降序。
3. 显示缩略图、时长、大小（可异步补齐）。

验收标准：
1. 1000 条视频列表在可接受时间内完成首屏展示。
2. 排序结果与系统相册拍摄时间一致。

### 4.3 F3 - 手动选择待迁移视频（新增）
1. 支持多选、全选、取消全选。
2. 实时显示选中项数量和预计迁移大小。
3. 不允许在“未选中任何视频”时开始迁移。

验收标准：
1. 选择状态在筛选、滚动后保持一致。
2. 选中统计与实际迁移清单一致。

### 4.4 F4 - 视频迁移与进度展示
1. 对选中视频逐个迁移到目标目录。
2. 迁移过程展示总进度和单文件状态。
3. 支持失败重试（单条和批量）。

验收标准：
1. 可成功迁移常见格式（mov/mp4）。
2. 外接存储被拔出时迁移中断并给出可恢复提示。

### 4.5 F5 - 迁移校验与删除原视频
1. 迁移成功后进行基础一致性校验。
2. 仅允许删除“校验通过”的源视频。
3. 删除前弹窗确认并显示释放空间预估。

验收标准：
1. 删除后相册不再显示对应视频。
2. 删除失败可回滚状态并提示用户手动处理。

### 4.6 F6 - 迁移记录与结果页
1. 记录每次任务的开始时间、数量、大小、结果。
2. 结果页可查看失败原因。

验收标准：
1. 异常退出后重新进入 App 可看到最近任务结果。

## 5. 关键产品约束

1. iOS 上“移动”实质为“复制 + 删除”。
2. 删除照片库内容必须由系统授权流程执行，不支持静默删除。
3. 外接存储路径访问需使用 `security-scoped` 资源能力。
4. 受系统限制，MVP 以“前台手动触发”为主，不承诺“插盘自动后台执行”。

## 6. 成功指标（MVP）

1. 任务成功率：`成功迁移视频数 / 选择视频数 >= 95%`（非外设中断场景）。
2. 平均释放空间：单次任务释放 `>= 2GB`（目标用户样本）。
3. 关键流程完成率：`扫描 -> 选择 -> 迁移 -> 删除` 完成率 `>= 70%`。
4. 关键崩溃率：迁移主流程崩溃率 `< 1%`。

## 7. 风险与应对

1. 权限拒绝风险：引导页说明权限用途，提供重试入口。
2. 外设不稳定风险：支持断点续传与失败重试。
3. 存储格式兼容风险：明确支持格式与错误提示。
4. 用户误删风险：删除前二次确认 + 仅允许删除已校验成功项。

## 8. 里程碑输出（与项目进度文档对齐）

1. 里程碑 A：MVP 核心链路可跑通（扫描/选择/迁移/删除）。
2. 里程碑 B：完成稳定性和异常恢复能力。
3. 里程碑 C：完成测试验收并发布 Beta。

---

# 最终总结（MVP）

## 本次交付范围（已完成）
1. 相册权限获取（支持“完全访问/限制访问/拒绝”，并对删除能力做权限收紧）。
2. 外接目录选择与记忆（Document Picker + bookmark；支持重新检查权限/重新选择）。
3. 扫描视频列表（默认按日期倒序；支持按大小从大到小/从小到大排序；显示视频大小）。
4. 用户手动选择迁移视频（多选/全选/清空/仅看已选；选中统计）。
5. 迁移到外接目录（导出到临时目录后协调写入外接盘；进度显示；失败原因可见）。
6. 迁移校验（最小一致性校验，作为“可删除”前置条件）。
7. 删除源视频（仅对“最近一次任务中迁移+校验成功”的条目开放；二次确认）。
8. 历史记录（查看每次迁移运行与条目结果，便于失败定位与追溯）。
9. 国际化（简体中文/英文，默认跟随系统）。

## 关键约束回顾
1. iOS 上“移动”本质是“复制到外接存储 + 可选删除相册原件”。
2. 相册删除必须走系统授权与 `PhotoKit` 变更事务，不支持静默删除。
3. 外接目录访问受 security scope / 文件协调等限制，MVP 采用前台手动触发，确保可控与可恢复。

## 下一步（非 MVP）
1. 更可靠的视频大小获取（避免依赖 KVC；或在导出/校验阶段补全真实 size）。
2. 断点续传与任务恢复（外设拔出/锁屏/异常退出的更强恢复）。
3. 更丰富筛选与批处理（按月份/大小阈值/时长等规则勾选）。
